networks:
  mkstore_net:

services:
  api_gateway:
    build: ./http-api-gateway
    ports:
      - 3000:3000
    volumes:
      - ./http-api-gateway/src:/usr/src/app/src
    command: bun start:dev
    environment:
      - PORT=3000
    networks:
      - mkstore_net

  # ───────────────────────────────────────────────
  # Users Service + Dedicated Database
  # ───────────────────────────────────────────────
  users_db:
    image: postgres:15
    container_name: users_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: users_service
      POSTGRES_PASSWORD: users_pass_very_secure_2026
      POSTGRES_DB: users_db
    ports:
      - "5433:5432"
    volumes:
      - users_data:/var/lib/postgresql/data
    networks:
      - mkstore_net

  users_microservice:
    build: ./users-microservice
    volumes:
      - ./users-microservice/src:/usr/src/app/src
      - ./users-microservice/.env:/usr/src/app/.env
    command: bun start:dev
    depends_on:
      - nats
      - users_db
    environment:
      - NODE_ENV=development
    networks:
      - mkstore_net

  # ───────────────────────────────────────────────
  # Products Service + Dedicated Database
  # ───────────────────────────────────────────────
  products_db:
    image: postgres:15
    container_name: products_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: products_service
      POSTGRES_PASSWORD: products_pass_very_secure_2026
      POSTGRES_DB: products_db
    ports:
      - "5434:5432"
    volumes:
      - products_data:/var/lib/postgresql/data
    networks:
      - mkstore_net

  products_microservice:
    build: ./products-microservice
    volumes:
      - ./products-microservice/src:/usr/src/app/src
      - ./products-microservice/.env:/usr/src/app/.env
    command: bun start:dev
    depends_on:
      - nats
      - products_db
    environment:
      - NODE_ENV=development
    networks:
      - mkstore_net

  # ───────────────────────────────────────────────
  # Payments Service + Dedicated Database
  # ───────────────────────────────────────────────
  payments_db:
    image: postgres:15
    container_name: payments_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: payments_service
      POSTGRES_PASSWORD: payments_pass_very_secure_2026
      POSTGRES_DB: payments_db
    ports:
      - "5435:5432"
    volumes:
      - payments_data:/var/lib/postgresql/data
    networks:
      - mkstore_net

  payments_microservice:
    build: ./payments-microservice
    volumes:
      - ./payments-microservice/src:/usr/src/app/src
      - ./payments-microservice/.env:/usr/src/app/.env
    command: bun start:dev
    depends_on:
      - nats
      - payments_db
    environment:
      - NODE_ENV=development
    networks:
      - mkstore_net

  # ───────────────────────────────────────────────
  # NATS Message Broker
  # ───────────────────────────────────────────────
  nats:
    image: nats:latest
    ports:
      - 4222:4222
    networks:
      - mkstore_net

volumes:
  users_data:
  products_data:
  payments_data:
